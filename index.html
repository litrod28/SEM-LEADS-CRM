<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SEM Leads CRM</title>
  <style>
    body { background: #f2f2f2; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; }
    #container { max-width: 1000px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 10px; box-shadow: 0 2px 12px 0 #d0d0d0; }
    h1 { color: #1877cc; }
    .row { display: flex; gap: 24px;}
    .column { flex: 1; }
    label { display: block; font-size: 15px; margin-top: 14px; }
    input, select, textarea { width: 100%; margin-top: 7px; font-size: 16px; padding: 7px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc;}
    button { background: #29a746; color: #fff; padding: 9px 24px; font-size: 16px; border: none; border-radius: 4px; margin-top: 10px; cursor: pointer; }
    button.secondary { background: #cc9318;}
    table { width: 100%; border-collapse: collapse; margin-top: 15px;}
    th, td { border: 1px solid #cce0fc; padding: 7px; }
    th { background: #ebf4fd; color: #1877cc;}
    .tag { display: inline-block; font-size: 14px; padding: 2px 10px; border-radius: 12px; color: #fff;}
    .Hot { background: #e63d22;}
    .Warm { background: #f5a623;}
    .Cold { background: #1e9fb7;}
    .NI { background: #707070;}
    .NRE { background: #b322a6;}
    #calendar-list { background: #f3feec; border-radius: 8px; padding: 14px; margin-top: 16px;}
    .flex { display: flex; gap: 10px; }
    .modal-bg { display: none; position: fixed; left:0; top:0; right:0; bottom:0; background:rgba(40,80,120,0.18); z-index:10; }
    .modal { display: none; position: fixed; left: 50vw; top: 15vh; transform: translate(-50%, 0); background: #fff; min-width:400px; border-radius:9px; box-shadow:0 8px 40px #aaa8; padding:24px; z-index:100;}
    .modal.open, .modal-bg.open { display: block;}
    #error { color: red; margin-bottom: 12px;}
    #welcome-popup {
      display:none; 
      position:fixed; 
      left:50%; top:20%; 
      transform:translate(-50%,-50%);
      background:#25a; 
      color:#fff; 
      padding:32px 50px; 
      border-radius:20px; 
      font-size:2rem; 
      box-shadow:0 8px 40px #9af5;
      z-index:2000;
      text-align:center;
    }
    #all-leads-section { margin-top: 20px; }
    #admin-section { margin-top: 20px; }
    .tabbar { margin: 17px 0; }
    .tabbar button.active { background: #1877cc; color: #fff; }
    @media(max-width:700px) { .row { flex-direction: column;}
      .modal, #container { min-width: unset; }
    }
  </style>
</head>
<body>
<div id="welcome-popup">Welcome, Admin!</div>

<div id="container">
  <div id="login-section">
    <h1>SEM Leads Login</h1>
    <div id="error"></div>
    <form id="loginForm">
      <label>Username</label>
      <input type="text" id="loginUser" autocomplete="username" required>
      <label>Password</label>
      <input type="password" id="loginPass" autocomplete="current-password" required>
      <button type="submit">Login</button>
    </form>
    <p style="font-size: 14px; margin-top:18px; color:#888;">
      Test Users: <br>
      sushant / sush@123<br>
      yash / yash@123<br>
      gaurav / gaurav@123<br>
    </p>
  </div>

  <!-- Dashboard Section, plus tabbed navigation -->
  <div id="dashboard-section" style="display:none;">
    <div style="display:flex; justify-content:space-between;align-items:center;">
      <h1>SEM Leads Dashboard</h1>
      <div style="font-size:1rem; color:#349;">Welcome, <span id="currentUser"></span></div>
      <button onclick="logout()" class="secondary" style="margin-left:10px;">Logout</button>
    </div>
    <!-- TAB NAVIGATION -->
    <div class="tabbar">
      <button id="tabAdmin" onclick="showAdminSection()">Admin</button>
      <button id="tabDashboard" onclick="showLeadsSection()">Dashboard</button>
      <button id="tabAllLeads" onclick="showAllLeadsSection()">All Leads</button>
    </div>
    <!-- Dashboard content (default tab) -->
    <div class="row" id="dashboardContentRow">
      <div class="column">
        <h2>Add New Lead</h2>
        <form id="leadForm">
          <label>Event Name</label>
          <input type="text" id="leadEventName" required>
          <label>Email</label>
          <input type="email" id="leadEmail" required>
          <label>Phone</label>
          <input type="text" id="leadPhone" required>
          <label>Designation</label>
          <input type="text" id="leadDesignation" required>
          <label>Organising Society</label>
          <input type="text" id="leadOrgSociety" required>
          <label>Category</label>
          <select id="leadCategory" required>
            <option value="">Select</option>
            <option value="Hot">Hot</option>
            <option value="Warm">Warm</option>
            <option value="Cold">Cold</option>
            <option value="NI">Not Interested</option>
            <option value="NRE">Not Reachable</option>
          </select>
          <label>Remarks</label>
          <textarea id="leadRemarks" rows="2"></textarea>
          <button type="submit">Add Lead</button>
        </form>
      </div>
      <div class="column">
        <h2>Today's Follow-ups</h2>
        <div id="calendar-list"></div>
      </div>
    </div>
    <!-- Admin Section -->
    <div id="admin-section" style="display:none;">
      <h2>Admin Panel</h2>
      <div style="margin:20px 0 30px 0; padding:18px; background:#e9f3fa;">
        <b>Hello, <span id="adminName"></span>!</b><br>
        Welcome to the admin panel.<br>
        <ul>
          <li>More admin tools and analytics can go here.</li>
          <li>Number of registered leads: <span id="adminTotalLeads"></span></li>
          <li>Today's follow-ups: <span id="adminTodaysFollowups"></span></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- All Leads/Search Page -->
  <div id="all-leads-section" style="display:none;">
    <h2>All Leads</h2>
    <input type="text" id="allSearchLead" placeholder="Search all leads by event name, email, phone, designation, society, category, remark..." style="margin-bottom:10px; width:90%; max-width:500px; font-size:17px; padding:0.7em;">
    <div id="allLeadsTableContainer"></div>
    <button onclick="showLeadsSection()" class="secondary" style="margin:20px 0;">Back to Dashboard</button>
  </div>
</div>

<!-- Modal for Add Follow-up -->
<div id="modalBg" class="modal-bg"></div>
<div id="followupModal" class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3>Add Follow-up</h3>
    <button type="button" onclick="closeFollowupModal()">âœ–</button>
  </div>
  <form id="followupForm">
    <div>For: <span id="fLeadName"></span></div>
    <label>Date & Time</label>
    <input type="datetime-local" id="followupDate" required>
    <label>Remark</label>
    <textarea id="followupRemark" rows="2" required></textarea>
    <button type="submit">Add</button>
  </form>
</div>

<script>
  // ----- User Demo Profiles -----
  const users = [
    { username: "sushant", password: "sush@123" },
    { username: "yash", password: "yash@123" },
    { username: "gaurav", password: "gaurav@123" }
  ];

  // LocalStorage keys
  const LEADS_KEY = "semleads_leads";
  const SESSION_KEY = "semleads_user";

  let currentUser = null;
  let leads = [];
  let addFollowupForIdx = null;

  // ------- TAB VIEW SWITCHING -------
  function setTabActive(tabId) {
    const tabBtns = {
      tabAdmin: document.getElementById("tabAdmin"),
      tabDashboard: document.getElementById("tabDashboard"),
      tabAllLeads: document.getElementById("tabAllLeads")
    };
    for (const k in tabBtns) tabBtns[k] && tabBtns[k].classList.remove("active");
    if (tabBtns[tabId]) tabBtns[tabId].classList.add("active");
  }

  function showLeadsSection() {
    setTabActive("tabDashboard");
    document.getElementById('admin-section').style.display = 'none';
    document.getElementById('dashboardContentRow').style.display = '';
    document.getElementById('all-leads-section').style.display = 'none';
    document.getElementById('dashboard-section').style.display = '';
  }
  function showAllLeadsSection() {
    setTabActive("tabAllLeads");
    document.getElementById('admin-section').style.display = 'none';
    document.getElementById('dashboardContentRow').style.display = 'none';
    document.getElementById('all-leads-section').style.display = '';
    document.getElementById('dashboard-section').style.display = '';
    renderAllLeadsTable();
  }
  function showAdminSection() {
    setTabActive("tabAdmin");
    document.getElementById('dashboard-section').style.display = '';
    document.getElementById('admin-section').style.display = '';
    document.getElementById('dashboardContentRow').style.display = 'none';
    document.getElementById('all-leads-section').style.display = 'none';
    document.getElementById('adminName').textContent = currentUser ?? "Admin";
    document.getElementById('adminTotalLeads').textContent = leads.length;
    document.getElementById('adminTodaysFollowups').textContent = countTodayFollowups();
  }

  // ------ Login Logic ------
  function showError(msg) {
    document.getElementById('error').textContent = msg;
  }
  function loginCheck(username, password) {
    return users.find(u => u.username === username && u.password === password);
  }

  document.getElementById('loginForm').onsubmit = function(e) {
    e.preventDefault();
    let user = document.getElementById('loginUser').value.trim();
    let pass = document.getElementById('loginPass').value;
    let res = loginCheck(user, pass);
    if (!res) return showError('Invalid username or password.');
    window.localStorage.setItem(SESSION_KEY, user);
    currentUser = user;
    showDashboard();
  };

  function logout() {
    window.localStorage.removeItem(SESSION_KEY);
    location.reload();
  }

  function showDashboard() {
    // Welcome popup
    document.getElementById('welcome-popup').style.display = 'block';
    setTimeout(() => {
      document.getElementById('welcome-popup').style.display = 'none';
      document.getElementById('login-section').style.display = "none";
      document.getElementById('dashboard-section').style.display = "";
      document.getElementById('all-leads-section').style.display = "none";
      document.getElementById('admin-section').style.display = "none";
      document.getElementById('dashboardContentRow').style.display = "";
      document.getElementById('currentUser').textContent = currentUser;
      leads = getStoredLeads();
      renderLeads();
      renderTodayFollowups();
      showLeadsSection(); // default to dashboard
    }, 1000);
  }

  // ------ Data Storage ------
  function getStoredLeads() {
    let arr = JSON.parse(window.localStorage.getItem(LEADS_KEY) || "[]");
    arr.forEach(lead => {
      if (!lead.followups) lead.followups = [];
    });
    return arr;
  }
  function saveLeads() {
    window.localStorage.setItem(LEADS_KEY, JSON.stringify(leads));
  }

  // ------ Add Lead ------
  document.getElementById('leadForm').onsubmit = function(e) {
    e.preventDefault();
    let newLead = {
      eventName: document.getElementById('leadEventName').value.trim(),
      email: document.getElementById('leadEmail').value.trim(),
      phone: document.getElementById('leadPhone').value.trim(),
      designation: document.getElementById('leadDesignation').value.trim(),
      organisingSociety: document.getElementById('leadOrgSociety').value.trim(),
      category: document.getElementById('leadCategory').value,
      remarks: document.getElementById('leadRemarks').value.trim(),
      followups: []
    };
    leads.push(newLead);
    saveLeads();
    renderLeads();
    renderTodayFollowups();
    renderAllLeadsTable();
    this.reset();
    alert('Lead added!');
  };

  // ------ Render Leads Table ------
  function renderLeads() {
    let html = `<table id="leadsTable">
      <tr>
        <th>Event Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Designation</th>
        <th>Organising Society</th>
        <th>Category</th>
        <th>Remarks</th>
        <th>Follow-ups</th>
      </tr>`;
    leads.forEach((lead, i) => {
      html += `<tr>
        <td>${lead.eventName}</td>
        <td>${lead.email}</td>
        <td>${lead.phone}</td>
        <td>${lead.designation}</td>
        <td>${lead.organisingSociety}</td>
        <td><span class='tag ${lead.category.split(' ')[0]}'>${lead.category}</span></td>
        <td>${lead.remarks || ''}</td>
        <td>
          ${lead.followups.length}
          <button type="button" onclick="openFollowupModal(${i})">Add</button>
          <br>
          ${lead.followups.map((f,idx) =>
            `<div style="font-size:13px;padding:2px;">
              ðŸ“† ${new Date(f.datetime).toLocaleString()}<br>
              <span style="color:#444;">${f.remark}</span>
              <span style="color:${f.done?'#317d3c':'#b53124'};font-weight:bold;">
                [${f.done?'Done':'Pending'}]
              </span>
              <button type="button" onclick="markFollowupDone(${i},${idx})" style="font-size:11px; margin-left:2px;">Mark Done</button>
            </div>`
          ).join('')}
        </td>
      </tr>`;
    });
    // Not displaying leads table on dashboard by default (to keep dashboard clean per your last direction)
    // If you want to show it, set: document.getElementById('leadsTableContainer').innerHTML = html;
  }

  // ------ All Leads Table ------
  function renderAllLeadsTable() {
    let q = document.getElementById('allSearchLead').value.trim().toLowerCase();
    let html = `<table id="allLeadsTable">
      <tr>
        <th>Event Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Designation</th>
        <th>Organising Society</th>
        <th>Category</th>
        <th>Remarks</th>
        <th>Follow-ups</th>
      </tr>`;
    leads.filter(lead =>
      [lead.eventName, lead.email, lead.phone, lead.designation, lead.organisingSociety, lead.category, lead.remarks].join("|").toLowerCase().includes(q)
    ).forEach((lead, i) => {
      html += `<tr>
        <td>${lead.eventName}</td>
        <td>${lead.email}</td>
        <td>${lead.phone}</td>
        <td>${lead.designation}</td>
        <td>${lead.organisingSociety}</td>
        <td><span class='tag ${lead.category.split(' ')[0]}'>${lead.category}</span></td>
        <td>${lead.remarks || ''}</td>
        <td>
          ${lead.followups.length}
          <button type="button" onclick="openFollowupModal(${i})">Add</button>
          <br>
          ${lead.followups.map((f,idx) =>
            `<div style="font-size:13px;padding:2px;">
              ðŸ“† ${new Date(f.datetime).toLocaleString()}<br>
              <span style="color:#444;">${f.remark}</span>
              <span style="color:${f.done?'#317d3c':'#b53124'};font-weight:bold;">
                [${f.done?'Done':'Pending'}]
              </span>
              <button type="button" onclick="markFollowupDone(${i},${idx})" style="font-size:11px; margin-left:2px;">Mark Done</button>
            </div>`
          ).join('')}
        </td>
      </tr>`;
    });
    html += "</table>";
    document.getElementById('allLeadsTableContainer').innerHTML = html;
  }
  document.getElementById('allSearchLead').oninput = renderAllLeadsTable;

  // ------ Follow-up Modal ------
  window.openFollowupModal = function(idx) {
    addFollowupForIdx = idx;
    document.getElementById('fLeadName').textContent = leads[idx].eventName;
    document.getElementById('followupDate').value = '';
    document.getElementById('followupRemark').value = '';
    document.getElementById('modalBg').classList.add('open');
    document.getElementById('followupModal').classList.add('open');
  };
  window.closeFollowupModal = function() {
    document.getElementById('modalBg').classList.remove('open');
    document.getElementById('followupModal').classList.remove('open');
  };

  document.getElementById('followupForm').onsubmit = function(e) {
    e.preventDefault();
    let dt = document.getElementById('followupDate').value;
    let remark = document.getElementById('followupRemark').value.trim();
    if (!dt) return alert('Date and time required!');
    leads[addFollowupForIdx].followups.push({
      datetime: dt,
      remark: remark,
      done: false
    });
    saveLeads();
    closeFollowupModal();
    renderLeads();
    renderTodayFollowups();
    renderAllLeadsTable();
  };

  // Mark follow-up as done
  window.markFollowupDone = function(leadIdx, fIdx) {
    leads[leadIdx].followups[fIdx].done = true;
    saveLeads();
    renderLeads();
    renderTodayFollowups();
    renderAllLeadsTable();
  };

  // ------ Calendar: Today's Follow-ups ------
  function renderTodayFollowups() {
    let now = new Date();
    let yyyy = now.getFullYear(), mm = now.getMonth(), dd = now.getDate();
    let todayStart = new Date(yyyy,mm,dd,0,0,0).getTime();
    let todayEnd   = new Date(yyyy,mm,dd,23,59,59).getTime();
    let html = '';
    leads.forEach((lead, i) => {
      lead.followups.forEach((f, idx) => {
        let ts = new Date(f.datetime).getTime();
        if(ts>=todayStart && ts<=todayEnd) {
          html += `<div class="flex" style="align-items:center; margin-bottom:7px;">
            <span class="tag ${lead.category.split(' ')[0]}" style="min-width:40px;">${lead.category}</span>
            <b style="color:#25a">${lead.eventName}</b>
            <span>${new Date(f.datetime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
            <span>${f.remark}</span>
            <span style="color:${f.done?'#337d34':'#b53124'};font-size:.94em;">[${f.done?'Done':'Pending'}]</span>
            <button type="button" onclick="markFollowupDone(${i},${idx});" style="font-size:13px;">Mark Done</button>
          </div>`;
        }
      });
    });
    document.getElementById('calendar-list').innerHTML = html || "<em>No follow-ups scheduled for today.</em>";
  }

  function countTodayFollowups() {
    let now = new Date();
    let yyyy = now.getFullYear(), mm = now.getMonth(), dd = now.getDate();
    let todayStart = new Date(yyyy,mm,dd,0,0,0).getTime();
    let todayEnd   = new Date(yyyy,mm,dd,23,59,59).getTime();
    let count = 0;
    leads.forEach((lead) =>
      lead.followups.forEach((f) => {
        let ts = new Date(f.datetime).getTime();
        if (ts >= todayStart && ts <= todayEnd) count++;
      })
    );
    return count;
  }

  // ------ Autofill Session ------
  window.onload = function() {
    currentUser = window.localStorage.getItem(SESSION_KEY);
    if(currentUser) showDashboard();
  };

  // Clicking background closes modal
  document.getElementById('modalBg').onclick = closeFollowupModal;
</script>
</body>
</html>
