<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CRM PORTAL SEM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts (Manrope, as in Appleâ€™s new design system) -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --glass-bg: rgba(255,255,255,0.19);
      --glass-border: rgba(194,230,255,0.40);
      --accent: #37dcfa;
      --shadow-accent: #81f1ff;
      --toggle-on: linear-gradient(93deg,#53e5ff 20%,#40eeea 99%);
      --toggle-off: #eaf6fa;
      --brand-gradient: linear-gradient(135deg,#e3f7ff60,#8cf6ff60 90%);
      --font-ui: 'Manrope', 'Segoe UI', Arial, sans-serif;
    }
    * { box-sizing: border-box; }
    html, body { height:100%; min-height:100%; margin:0; padding:0;}
    body {
      font-family: var(--font-ui); font-smoothing: antialiased;
      color: #173d55;
      background: url('image.jpg') center center/cover no-repeat, radial-gradient(ellipse 80% 90% at 80% 10%, #f2fdff 60%, #e4fafe 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      z-index: 1;
    }
    /* Blobs/drops for interactive glassmorphism */
    .bg-blob {
      position: fixed; z-index: 0; pointer-events: none;
      border-radius: 33% 67% 47% 53% / 59% 31% 69% 41%;
      opacity: .31; filter: blur(9px);
      animation: blobmove 13s linear infinite alternate;
      background: linear-gradient(120deg,#bbf0ff 54%,#e3faff 100%);
    }
    .bg-blob.one { width:370px;height:260px;left:-110px;top:90px;}
    .bg-blob.two { width:220px;height:150px;right:-70px;top:108px; background: linear-gradient(120deg,#e1f6fd 33%,#90eaff 100%);}
    .bg-blob.three { width:230px;height:240px;left:62%;top:420px;}
    .bg-drop {
      position: fixed; z-index: 1;
      width: 80px; height: 80px;
      top: 61%; left: 6%;
      border-radius: 44% 56% 60% 40%;
      opacity: .21; background: #aeeffd;
      filter: blur(5px);
      animation: blobdrop 7.5s linear infinite alternate;
    }
    @keyframes blobmove {
      to { transform: translateY(50px) scale(1.09) rotate(13deg);}
    }
    @keyframes blobdrop {
      to { left:10%; top: 63%; opacity:.12;}
    }
    /* ========== GLASS CARDS, MODERN EFFECTS ========== */
    .glass {
      background: var(--glass-bg);
      border: 1.7px solid var(--glass-border);
      border-radius: 2.1rem;
      box-shadow:
        0 8px 46px 0 #7ce5ff19,
        0 1px 18px 0 #7cdfed19,
        0 2px 10px 0 #fff9d021;
      backdrop-filter: blur(26px);
      -webkit-backdrop-filter: blur(26px);
      transition: background .13s, box-shadow .13s, border .19s;
    }
    .glass:hover, .tab.active {
      box-shadow: 0 0 44px 0 var(--accent), 0 5px 40px #a8e7ff75, 0 1px 12px #fffde040;
      border: 1.7px solid #fffafc;
      background-image: linear-gradient(
        113deg, rgba(255,255,255,0.10) 25%, rgba(255,255,255,0.21) 95%);
      background-size: 220% 220%;
      animation: shineAnim 1.05s cubic-bezier(.45,.1,.75,1) forwards;
    }
    @keyframes shineAnim {
      0% {background-position: 190% 0;} 100% {background-position: -190% 0;}
    }
    /* Navbar styling - above scroll, always visible */
    .navbar {
      display: flex; justify-content: flex-end; align-items: center;
      width: 100%; padding: 24px 6vw 0 0;
      gap: 14px;
      position: fixed; z-index: 8; top: 0; left: 0; right: 0;
      pointer-events: none; min-height: 70px;
      background: none;
    }
    .navbar .username {
      color: #0d3c75; font-weight: 700; font-size: 1.06rem; background: #eafffbf1;
      padding: 11px 32px; border-radius: 42px; border: 1px solid #e7f7fa;
      box-shadow: 0 2px 18px #58eeea19;
      pointer-events: auto; user-select: text;
    }
    .navbar button {
      font-size: 1.07rem; font-family: inherit; font-weight: 600; letter-spacing: 0.02em;
      padding: 10px 28px;
      margin-left: 0;
      border: none; border-radius: 34px; cursor: pointer;
      background: linear-gradient(107deg,#b9f5fdee,#37f1f3cc 90%);
      color: #045269;
      box-shadow: 0 2px 13px #c4f3ff16;
      pointer-events: auto; position: relative; z-index: 2;
      transition: background .15s, color .17s, box-shadow .14s;
    }
    .navbar button:hover {
      background: linear-gradient(120deg,#d9f7fd,#9cfff6e4 99%);
      color: #28b3ff; box-shadow: 0 4px 16px #54e3ff22;
    }
    .dashboard {
      max-width: 1072px; margin: 116px auto 0 auto;
      padding: 37px 3vw 39px 3vw;
      min-height: 600px; position: relative; z-index: 3;
    }
    .tab-bar {
      display: flex; gap: 2.2rem; margin-bottom: 2.1rem; background:none;
    }
    .tab {
      flex:1; min-width:147px; text-align:center; font-size:1.11rem;
      padding: 1.03rem 0.8rem; cursor:pointer;
      color: #0880ae; background: #e8f8ff8f;
      border-radius: 2rem; font-weight: 700;
      border: 1px solid #e2f5ffcb;
      transition: box-shadow .16s, background .15s, color .16s;
      margin-right:.48rem; font-family:inherit; letter-spacing:0.02em;
      position:relative; z-index:2;
    }
    .tab.active, .tab:hover {
      color: #1f62bb; font-weight: bold;
      background: var(--brand-gradient);
      box-shadow: 0 0 26px 0 var(--shadow-accent), 0px 2px 24px #62cafc41;
    }
    .tab:last-child { margin-right:0;}
    /* Main content (card glass) */
    .tab-content {
      animation: fadeInTab .7s cubic-bezier(.45,.08,.45,1.22);
      font-family: inherit;
      min-height:160px;
      font-size:1.01rem;
      padding-bottom: 18px;
    }
    @keyframes fadeInTab {
      0%{ opacity:.01; transform: translateY(30px);}
      100%{opacity:1; transform: translateY(0);}
    }
    .section-title {
      font-size: 1.08rem;
      font-weight: 700;
      color: #16a1af;
      letter-spacing: 0.09em;
      margin-bottom: 15px;
    }
    .card {
      background: rgba(255,255,255,0.28); border-radius: 29px;
      box-shadow: 0 8px 46px 0 #99e4ff2f,0 1px 18px #77cdf512,0 2px 10px #fffad920;
      backdrop-filter: blur(23px); border: 1px solid #e8effa43;
      margin-bottom:2rem; padding: 2rem 1.25rem 1.45rem 2.0rem;
      position:relative;
    }
    /* Table design */
    .leads-table, .report-table {
      width: 100%; border-collapse: separate; border-spacing: 0 8px; font-size: 0.99rem;
    }
    .leads-table th, .leads-table td, .report-table th, .report-table td {
      background: rgba(255,255,255,0.89); text-align: left;
      padding: 0.77rem 0.7rem; border-radius: 14px;
      color: #087bad; font-size: 1em; box-shadow: 0 1px 2px #b6edfc09;
    }
    .leads-table th, .report-table th {background:#f2fcfff8;font-weight:700;color:#169ab0;}
    /* Search bar/input refinements */
    #lead-search {
      background: #f7fcff; color:#145566;
      border: 1.4px solid #caf1ff99;
      border-radius: 14px; transition: box-shadow .20s;
      font-size: 1.0rem;
    }
    #lead-search:focus {
      outline: none; box-shadow: 0 0 1px 3px #4ee7ff42;
    }
    /* Lead Form/Editor fields */
    .lead-form {
      display: flex; flex-direction: column; gap: 1.07rem; max-width:480px;
    }
    .lead-form label { font-weight: 700; font-size:1.07rem; color:#206691;}
    .lead-form input, .lead-form select, .lead-form textarea {
      border: 1.2px solid #caf1ffab; background:#f7fcff;
      padding: 0.72rem 1.1rem; border-radius: 13px;
      margin-top: 0.18rem; margin-bottom: 0.41rem;
      font-size: 1.03rem; color:#126990;
      box-shadow: 0 0.9px 7px #28e7ff0d; outline:none;
      transition: background .16s, box-shadow .19s;
      font-family: inherit;
    }
    .lead-form input:focus, select:focus, textarea:focus {
      background:#ecf9fa; box-shadow: 0 0 0 2.1px #3eeaff33;
    }
    .lead-form select { cursor:pointer; }
    .lead-form textarea { resize: vertical; min-height: 55px; }
    /* Toggle (Liquid Glass, interactive) */
    .crm-toggle {
      width: 54px; height: 32px; border-radius: 18px;
      background: var(--toggle-off); border: 1.35px solid #e0faff;
      position:relative; cursor:pointer; display:inline-block;
      vertical-align:middle; box-shadow: 0 2px 14px #61e6ff15;
      transition: box-shadow .27s, background .34s;
    }
    .crm-toggle[data-checked="true"] {
      background: var(--toggle-on); box-shadow: 0 2px 17px #0bd4dd37,0 0 8px #84e7ff33 inset;
    }
    .crm-toggle > span {
      display: block; position:absolute; left:4px; top:3.5px;
      width:24px;height:24px; border-radius:50%; background:#fff;
      box-shadow:0 2px 10px #78ecfc2a;
      transition: left .27s cubic-bezier(.76,0,.46,1.2), background .19s;
    }
    .crm-toggle[data-checked="true"] > span{ left:27px; background:#f6ffff;}
    .crm-toggle-label {
      margin-left: 12px; font-size:1.04rem; font-weight:600; color:#155bb0;
      letter-spacing:0.01em;
    }
    /* Popup styling */
    .popup { position: fixed; top:70px; left:0; width:100vw;
      display:flex; z-index:99; justify-content:center;
      animation: fadeInOut 1.02s linear forwards;
      pointer-events:none;
    }
    .popup .glass {
      min-width:150px; font-weight:700; color:#146890;
      font-size: 1.18rem; text-align:center;
      padding:1.10rem 2.4rem;
      background:rgba(255,255,255,0.97);
      border-radius:18px;
      border:2.4px solid #8efcff32;
      box-shadow: 0 6px 32px #85e7ff14;
    }
    @keyframes fadeInOut {
      0%{opacity:0;transform:translateY(-30px);}12%{opacity:1;transform:translateY(0);}80%{opacity:1;}100%{opacity:0;transform:translateY(-30px);}
    }
    /* Button */
    .glass-btn, .followup-btn {
      cursor:pointer;
      background:linear-gradient(90deg,#5de5fc 60%,#c2f2fa 100%);
      color:#1e4c67;
      padding: .60rem 1.18rem;
      border:none; border-radius:15px;
      font-size:1rem; font-weight:700; margin-top:.21rem;
      transition:background .20s, color .15s;
      box-shadow: 0 2px 10px #85e1fa2d;
      font-family:inherit;
    }
    .glass-btn:hover, .followup-btn:hover { background: linear-gradient(90deg,#44dafc 10%,#33e0e4 99%); color:#fff;}
    .followup-btn {margin-top:.23rem; background:linear-gradient(90deg,#d1f8ff,#e6f8fb);}
    .followup-btn:hover { background: var(--accent);}
    /* Responsive */
    @media (max-width: 850px) {
      .dashboard{padding: 18px 1vw;}
      .tab-bar { flex-direction:column; gap:10px;}
      .tab{ margin-right:0; min-width:80px;}
      .navbar { padding:13px 1vw 0 0; min-height:48px;}
    }
    @media (max-width: 1150px) {
      .navbar {padding-right:1.7vw;}
    }
  </style>
</head>
<body>
  <div class="bg-blob one"></div>
  <div class="bg-blob two"></div>
  <div class="bg-blob three"></div>
  <div class="bg-drop"></div>
  <!-- Popup -->
  <div id="popup" class="popup" style="display:none;">
    <div class="glass" id="popup-content"></div>
  </div>
  <!-- Login Screen -->
  <div id="login-screen">
    <form class="login-box glass" onsubmit="login(event)">
      <h2 style="font-family:'Manrope',sans-serif;font-weight:700;font-size:2rem;color:#0099c9;letter-spacing:2px;margin-bottom:20px;">CRM PORTAL SEM</h2>
      <div class="login-field">
        <label for="username" style="font-weight:600;">Username</label>
        <input id="username" autocomplete="username" required>
      </div>
      <div class="login-field">
        <label for="password" style="font-weight:600;">Password</label>
        <input type="password" id="password" autocomplete="current-password" required>
      </div>
      <button class="glass-btn" type="submit" style="font-family:'Manrope',sans-serif;">Login</button>
      <div class="form-links" style="color:#1584b8;margin-top:.7em;font-weight:600;">Usernames: sushant, gaurav, yash, shikha, tripti, anshi, sem, developer</div>
    </form>
  </div>
  <!-- Main Dashboard -->
  <div id="main-app" style="display:none;">
    <div class="navbar">
      <span class="username" id="user-label"></span>
      <button onclick="logout()">Logout</button>
    </div>
    <div class="dashboard">
      <div class="tab-bar" id="tab-bar"></div>
      <div class="tab-content glass" id="tab-content"></div>
    </div>
  </div>
  <script>
    // Data and login
    const users = [
      {username:"sushant", password:"sush@123", role:"user"},
      {username:"gaurav", password:"gaurav@123", role:"user"},
      {username:"yash", password:"yash@123", role:"user"},
      {username:"shikha", password:"shikha@123", role:"user"},
      {username:"tripti", password:"tripti@123", role:"user"},
      {username:"anshi", password:"anshi@123", role:"user"},
      {username:"sem", password:"semops@123", role:"sem"},
      {username:"developer", password:"dev041228", role:"developer"},
    ], fontUI = "'Manrope','Segoe UI',sans-serif";
    let leads = [], followups = [], session_user = null;
    function capitalize(str) { return str.slice(0,1).toUpperCase() + str.slice(1); }
    function showPopup(msg) {
      const popup = document.getElementById('popup');
      popup.style.display = '';
      document.getElementById('popup-content').textContent = msg;
      setTimeout(()=>{ popup.style.display='none'; }, 1010);
    }
    function formatDateIST(date) {
      const d = new Date(date);
      return d.toLocaleString('en-IN', {timeZone:'Asia/Kolkata'});
    }
    function generateId() { return Math.random().toString(36).substr(2,9) + Date.now(); }
    // Toggle UI (glass animated)
    function crmToggle(el, checked, onChange) {
      el.setAttribute("data-checked", String(checked));
      el.onclick = () => { 
        el.setAttribute("data-checked", String(!JSON.parse(el.getAttribute("data-checked"))));
        onChange && onChange(JSON.parse(el.getAttribute("data-checked")));
      };
    }
    // LOGIN
    function login(e) {
      e.preventDefault();
      const uname = document.getElementById('username').value.trim().toLowerCase();
      const pwd = document.getElementById('password').value;
      const user = users.find(u=>u.username===uname && u.password===pwd);
      if (!user) { showPopup("Incorrect username or password"); return; }
      session_user = {...user};
      showPopup(`Welcome, ${capitalize(session_user.username)}!`);
      document.getElementById('login-screen').style.display='none';
      document.getElementById('main-app').style.display='';
      renderDashboard();
    }
    function logout() {
      session_user=null;
      document.getElementById('main-app').style.display='none';
      document.getElementById('login-screen').style.display='';
      document.getElementById('username').value='';
      document.getElementById('password').value='';
    }
    function renderDashboard() {
      document.getElementById('user-label').innerText = capitalize(session_user.username);
      let tabs=[];
      if (session_user.role==='user') tabs = [
        {label: "User", fn: renderUserTab},
        {label: "Add Lead", fn: renderAddLeadTab},
        {label: "My Leads", fn: renderMyLeadsTab},
      ];
      else if (session_user.role==='sem') tabs = [
        {label: "Add & Assign Lead", fn: renderSemAddAssignLead},
        {label: "All Leads", fn: renderSemAllLeads},
        {label: "Report", fn: renderSemReport},
      ];
      else if (session_user.role==='developer') tabs = [
        {label: "Admin â€” Users", fn: renderDevUsers},
        {label: "Admin â€” Leads", fn: renderSemAllLeads},
        {label: "Admin â€” Report", fn: renderSemReport},
      ];
      // Tab bar
      const tabbar = document.getElementById('tab-bar'); tabbar.innerHTML = '';
      tabs.forEach((tab, i) => {
        let div = document.createElement('div');
        div.className = 'tab'; div.textContent = tab.label;
        div.onclick = () => { selectTab(i); };
        if(i===0) div.classList.add('active');
        tabbar.appendChild(div);
      });
      window.__currTabs = tabs;
      selectTab(0);
    }
    function selectTab(idx) {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach((tab, i) => tab.classList.toggle('active', i===idx));
      document.getElementById('tab-content').innerHTML = '';
      setTimeout(()=>{ window.__currTabs[idx].fn(); }, 60);
    }
    // USER TAB
    function renderUserTab() {
      const userLeads = leads.filter(l=>l.assignedTo===session_user.username);
      const today = new Date().toISOString().substring(0,10);
      const followupDone = followups.filter(f=>f.user===session_user.username && f.status==="done" && f.date.split('T')[0]===today).length;
      const overdue = followups.filter(f=>
        f.user===session_user.username && f.status!=='done' && new Date(f.date)<new Date()
      );
      const reminders = followups.filter(f=>
        f.user===session_user.username && f.status!=='done' && f.date.split('T')[0]===today
      );
      let html = `<div class="card">
        <div class="section-title">User Overview</div>
        <div><b>Name:</b> <span style="font-weight:700">${capitalize(session_user.username)}</span></div>
        <div><b>Leads added:</b> <span style="font-weight:700">${userLeads.length}</span></div>
        <div><b>Follow-up done today:</b> <span style="font-weight:700">${followupDone}</span></div>
        <div style="margin-top:.8em;"><b>Overdue Follow-ups:</b></div>
        <ul>${overdue.map(f=>`<li>${f.leadEventName} &mdash; ${formatDateIST(f.date)}</li>`).join('')||'<li>(none)</li>'}</ul>
        <div style="margin-top:1.2em;"><b>Follow-up reminders for today:</b></div>
        <ul style="padding-left:0;">${
          reminders.length?
            reminders.map(f=>`
              <li style="margin-bottom:.4em;">
                <span style="font-weight:600">${f.leadEventName}</span> &mdash; ${formatDateIST(f.date)}
                <span style="margin-left:14px;vertical-align:middle;">
                  <div class="crm-toggle" data-checked="false" id="toggle_fup_${f.id}" style="display:inline-block;vertical-align:middle;"><span></span></div>
                  <span class="crm-toggle-label" style="vertical-align:middle;">Mark done</span>
                </span>
              </li>
            `).join(''):'<li>(none)</li>'
        }</ul>
      </div>`;
      document.getElementById('tab-content').innerHTML = html;
      reminders.forEach(f=>{
        let el = document.getElementById(`toggle_fup_${f.id}`);
        crmToggle(el, false, (chkd)=>{ if(chkd) { f.status="done"; showPopup("Marked as done"); renderUserTab(); } });
      });
    }
    // ADD LEAD (User)
    function renderAddLeadTab() {
      const fields = `
        <form class="lead-form" onsubmit="addLead(event)">
          <label>Event Name <input required name="eventName"></label>
          <label>Organising Society <input required name="orgSociety"></label>
          <label>Contact Person <input required name="contactPerson"></label>
          <label>Phone No. <input required name="phone" maxlength="15"></label>
          <label>Email <input type="email" required name="email"></label>
          <label>Lead Stage
            <div class="lead-stage" style="display:flex;gap:.72em;">
              ${["hot","wrm","cld","ni","nre","junk"].map(lv=>
                `<label style="font-family:${fontUI};font-weight:700;">
                  <input type="radio" name="leadStage" value="${lv}" required style="vertical-align:middle;">
                  <span style="margin-left:4px;">${lv.toUpperCase()}</span>
                </label>`
              ).join('')}
            </div>
          </label>
          <label>Remarks <textarea name="remarks"></textarea></label>
          <label>Followup Date & Time <input type="datetime-local" required name="followup"></label>
          <button class="glass-btn" type="submit">Add Lead</button>
        </form>
      `;
      document.getElementById('tab-content').innerHTML = `<div class="card">${fields}</div>`;
    }
    function addLead(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const leadId = generateId();
      let lead = {
        id: leadId,
        eventName: fd.get("eventName"),
        orgSociety: fd.get("orgSociety"),
        contactPerson: fd.get("contactPerson"),
        phone: fd.get("phone"),
        email: fd.get("email"),
        leadStage: fd.get("leadStage"),
        remarks: fd.get("remarks"),
        assignedTo: session_user.username,
        dateAdded: new Date().toISOString(),
      };
      leads.push(lead);
      followups.push({
        id: generateId(), user: session_user.username,
        leadId, leadEventName: lead.eventName, date: fd.get("followup"), status: "pending"
      });
      showPopup("Lead Added!");
      renderDashboard();
    }
    // MY LEADS (search, edit, timepicker, toggles)
    function renderMyLeadsTab() {
      let html = `<div class="card">
        <div style="display:flex;align-items:center;gap:2rem;margin-bottom:12px;">
          <span class="section-title" style="font-size:1.11rem;">My Leads</span>
          <input id="lead-search" placeholder="ðŸ” Search Lead" style="flex:0 0 210px;max-width:220px;padding:.7em 0.65em;border-radius:14px;font-size:1rem;border:1.4px solid #caf1ff99;background:#f7fcff;color:#144566;" oninput="renderMyLeadsTab()">
        </div>
        <div style="overflow-x:auto;">
        <table class="leads-table">
        <tr>
          <th>Event Name</th><th>Society</th><th>Contact</th><th>Phone</th><th>Email</th>
          <th>Lead Stage</th><th>Remarks</th><th>Date Added</th><th>Follow-up</th><th>Actions</th>
        </tr>`;
      let s = document.getElementById('lead-search');
      let query = (s && s.value) ? s.value.trim().toLowerCase() : '';
      let rows = leads.filter(l=>l.assignedTo===session_user.username &&
        (!query || Object.values(l).join(' ').toLowerCase().includes(query))
      ).map(l=>{
        const fups = followups.filter(f=>f.leadId===l.id && f.user===session_user.username)
        .map(f=>
          `<div style="margin-bottom:3px;">
            <input type="datetime-local" style="font-size:.95em;max-width:156px;border-radius:9px;border:1px solid #badefd;background:#f5fcff;" value="${f.date.replace(' ','T').substring(0,16)}"
              onchange="event.stopPropagation(); fupDate('${f.id}',this.value)">
            <div class="crm-toggle" data-checked="${f.status==='done'}" id="toggle_mytab_${f.id}" style="display:inline-block;vertical-align:middle;margin-left:5px;"><span></span></div>
          </div>`
        ).join('');
        return `<tr>
          <td contenteditable="true" onblur="editLead('${l.id}','eventName',this.innerText)">${l.eventName}</td>
          <td contenteditable="true" onblur="editLead('${l.id}','orgSociety',this.innerText)">${l.orgSociety}</td>
          <td contenteditable="true" onblur="editLead('${l.id}','contactPerson',this.innerText)">${l.contactPerson}</td>
          <td contenteditable="true" onblur="editLead('${l.id}','phone',this.innerText)">${l.phone}</td>
          <td contenteditable="true" onblur="editLead('${l.id}','email',this.innerText)">${l.email}</td>
          <td contenteditable="true" onblur="editLead('${l.id}','leadStage',this.innerText)">${l.leadStage}</td>
          <td contenteditable="true" onblur="editLead('${l.id}','remarks',this.innerText)">${l.remarks||''}</td>
          <td>${formatDateIST(l.dateAdded)}</td>
          <td>${fups}
            <button class="followup-btn" style="margin-top:5px;" onclick="addLeadFollowup('${l.id}','${l.eventName}')">+</button>
          </td>
          <td>
            <button class="followup-btn" style="background:#fafbfd;color:#b03e11;" onclick="deleteLead('${l.id}')">Delete</button>
          </td>
        </tr>`;
      }).join('');
      html += (rows||'') + `</table></div></div>`;
      document.getElementById('tab-content').innerHTML = html;
      leads.filter(l=>l.assignedTo===session_user.username)
        .forEach(l=>{followups.filter(f=>f.leadId===l.id && f.user===session_user.username)
        .forEach(f=>crmToggle(document.getElementById(`toggle_mytab_${f.id}`), f.status==="done", (chkd)=>{f.status = chkd ? "done" : "pending"; showPopup("Updated");}));});
    }
    function addLeadFollowup(leadId,eventName) {
      let dt = prompt("Enter follow-up datetime (YYYY-MM-DDTHH:MM):");
      if(dt && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(dt)) {
        followups.push({
          id:generateId(), user:session_user.username, leadId, leadEventName:eventName, date:dt, status:"pending"
        });
        showPopup("Follow-up Added!"); renderMyLeadsTab();
      }
    }
    function fupDate(fupId,val) {
      let f = followups.find(x=>x.id===fupId);
      if (f) { f.date = val; showPopup("Follow-up date updated."); }
    }
    function editLead(leadId,field,val) {
      let l = leads.find(l=>l.id===leadId);
      if(l) { l[field] = val; showPopup("Lead updated."); }
    }
    function deleteLead(leadId) {
      if(confirm("Delete this lead?")) {
        leads = leads.filter(l=>l.id!==leadId);
        followups = followups.filter(f=>f.leadId!==leadId);
        renderMyLeadsTab();
        showPopup("Deleted!");
      }
    }
    // SEM and Developer (same structure, glass tabs)
    function renderSemAddAssignLead() {
      let userOptions = users.filter(u=>u.role==="user").map(u=>`<option value="${u.username}">${capitalize(u.username)}</option>`).join('');
      const fields = `
        <form class="lead-form" onsubmit="semAddLead(event)">
          <label>Event Name <input required name="eventName"></label>
          <label>Organising Society <input required name="orgSociety"></label>
          <label>Contact Person <input required name="contactPerson"></label>
          <label>Phone No. <input required name="phone" maxlength="15"></label>
          <label>Email <input type="email" required name="email"></label>
          <label>Lead Stage
            <div class="lead-stage">
              ${["hot","wrm","cld","ni","nre","junk"].map(lv=>
                `<label style="font-family:${fontUI};font-weight:700;">
                  <input type="radio" name="leadStage" value="${lv}" required style="vertical-align:middle;">
                  <span style="margin-left:4px;">${lv.toUpperCase()}</span>
                </label>`
              ).join('')}
            </div>
          </label>
          <label>Remarks <textarea name="remarks"></textarea></label>
          <label>Followup date/time <input type="datetime-local" required name="followup"></label>
          <label>Assign to
            <select required name="assignedTo">${userOptions}</select>
          </label>
          <button class="glass-btn" type="submit">Add & Assign Lead</button>
        </form>
      `;
      document.getElementById('tab-content').innerHTML = `<div class="card">${fields}</div>`;
    }
    function semAddLead(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const leadId = generateId();
      let lead = {
        id:leadId,
        eventName: fd.get("eventName"),
        orgSociety: fd.get("orgSociety"),
        contactPerson: fd.get("contactPerson"),
        phone: fd.get("phone"),
        email: fd.get("email"),
        leadStage: fd.get("leadStage"),
        remarks: fd.get("remarks"),
        assignedTo: fd.get('assignedTo'),
        dateAdded: new Date().toISOString(),
      };
      leads.push(lead);
      followups.push({id: generateId(), user: fd.get('assignedTo'), leadId, leadEventName:lead.eventName, date: fd.get("followup"), status:"pending"});
      showPopup("Lead Added & Assigned!"); renderDashboard();
    }
    function renderSemAllLeads() {
      let usersList = ["all"].concat(users.filter(u=>u.role==="user").map(u=>u.username));
      let filterUserOptions = usersList.map(u=>`<option value="${u}">${capitalize(u)}</option>`).join('');
      let html = `
        <div class="card">
          <div style="display:flex;align-items:center;gap:1.5rem;">
            <div class="section-title">All Leads</div>
            <select id="filter-user" class="glass" style="padding:0.6rem;">${filterUserOptions}</select>
            <input id="filter-date" type="date" class="glass" style="padding:0.6rem;">
            <button class="glass-btn" onclick="applyLeadFilter()">Filter</button>
          </div>
          <table class="leads-table" id="all-leads-table">
          <tr>
            <th>Event Name</th><th>Society</th><th>Contact</th><th>Phone</th>
            <th>Email</th><th>Lead Stage</th><th>Remarks</th>
            <th>Assigned To</th><th>Date Added</th>
          </tr>
          ${leads.map(l=>
            `<tr>
              <td>${l.eventName}</td><td>${l.orgSociety}</td><td>${l.contactPerson}</td><td>${l.phone}</td>
              <td>${l.email}</td><td>${l.leadStage}</td><td>${l.remarks||''}</td>
              <td>${capitalize(l.assignedTo)}</td>
              <td>${formatDateIST(l.dateAdded)}</td>
            </tr>`
          ).join('')}
          </table>
        </div>
      `;
      document.getElementById('tab-content').innerHTML = html;
    }
    function applyLeadFilter() {
      let uname=document.getElementById('filter-user').value;
      let dt=document.getElementById('filter-date').value;
      let data = leads;
      if(uname && uname!=='all') data = data.filter(l=>l.assignedTo===uname);
      if(dt) data = data.filter(l=>l.dateAdded.substring(0,10)===dt);
      let tb = document.getElementById('all-leads-table');
      tb.innerHTML = `<tr>
        <th>Event Name</th><th>Society</th><th>Contact</th><th>Phone</th>
        <th>Email</th><th>Lead Stage</th><th>Remarks</th>
        <th>Assigned To</th><th>Date Added</th>
        </tr>` + 
        data.map(l=>
          `<tr>
            <td>${l.eventName}</td><td>${l.orgSociety}</td><td>${l.contactPerson}</td><td>${l.phone}</td>
            <td>${l.email}</td><td>${l.leadStage}</td><td>${l.remarks||''}</td>
            <td>${capitalize(l.assignedTo)}</td>
            <td>${formatDateIST(l.dateAdded)}</td>
          </tr>`
        ).join('');
    }
    function renderSemReport() {
      let usersList = users.filter(u=>u.role==="user");
      const today = new Date().toISOString().substring(0,10);
      let html = `
        <div class="card">
          <div style="display:flex;align-items:center;gap:1.5rem;">
            <div class="section-title">Report (per user, for today)</div>
            <input id="report-date" type="date" class="glass" style="padding:0.6rem;" value="${today}">
            <button class="glass-btn" onclick="applyReportFilter()">Filter</button>
          </div>
          <table class="report-table" id="report-table">
          <tr>
            <th>User</th>
            <th>No. of Leads</th><th>Follow-ups</th>
          </tr>
          ${usersList.map(u=>{
            const leadsToday = leads.filter(l=>l.assignedTo===u.username && l.dateAdded.substring(0,10)===today).length;
            const flToday = followups.filter(f=>f.user===u.username && f.date.split('T')[0]===today).length;
            return `<tr>
              <td>${capitalize(u.username)}</td>
              <td>${leadsToday}</td>
              <td>${flToday}</td>
            </tr>`;
          }).join('')}
          </table>
        </div>
      `;
      document.getElementById('tab-content').innerHTML = html;
    }
    function applyReportFilter() {
      let dt = document.getElementById('report-date').value;
      let usersList = users.filter(u=>u.role==="user");
      let tb = document.getElementById('report-table');
      tb.innerHTML = `<tr>
        <th>User</th>
        <th>No. of Leads</th><th>Follow-ups</th>
      </tr>` + 
      usersList.map(u=>{
        const leadsToday = leads.filter(l=>l.assignedTo===u.username && l.dateAdded.substring(0,10)===dt).length;
        const flToday = followups.filter(f=>f.user===u.username && f.date.split('T')[0]===dt).length;
        return `<tr>
          <td>${capitalize(u.username)}</td>
          <td>${leadsToday}</td>
          <td>${flToday}</td>
        </tr>`;
      }).join('');
    }
    function renderDevUsers() {
      let html = `
        <div class="card">
          <div class="section-title">Admin: User Management</div>
          <table class="report-table">
          <tr><th>User</th><th>Role</th><th>Password (reset)</th></tr>
          ${users.map((u,i)=>`
            <tr>
              <td><input style="width:120px" value="${u.username}" onchange="devSetUsername(${i},this.value)"></td>
              <td>${u.role}</td>
              <td><input style="width:120px" type="password" value="${u.password}" onchange="devSetPassword(${i},this.value)"></td>
            </tr>`).join('')}
          </table>
        </div>
      `;
      document.getElementById('tab-content').innerHTML = html;
    }
    function devSetUsername(idx,val) { users[idx].username = val.trim().toLowerCase(); showPopup("Username changed."); }
    function devSetPassword(idx,val) { users[idx].password = val; showPopup("Password changed."); }
    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('main-app').style.display='none';
    });
  </script>
</body>
</html>
